<?

function check_rights( $domainId, $server ) {

	$url = $server.'robots.txt';

	$page = get_page( $domainId, 'robot', $url );

	if( $page !== false ) {
		storeRobot( $domainId, $page );
	}

	return true;

}

function storeHeader( $domainId, $page, $headers ) {

	if( is_array( $headers ) && count( $headers )) {

		$headers = addslashes(serialize( $headers ));

		$sql = "SELECT `domainId` FROM `cacheHeader` WHERE `page` = '{$page}' AND `domainId` = '$domainId'";
		$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		if( $res && ( mysql_num_rows( $res ) >0 )) {

			mysql_free_result( $res ) or error_sql( $sql, mysql_error() );

			$sql = "UPDATE `cacheHeader` SET `date` = NOW(), `header` = compress('{$headers}') WHERE `page` = '{$page}' AND `domainId` = '$domainId'";
			$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		} else {

			$sql = "INSERT INTO `cacheHeader` (`domainId`,`date`,`page`,`header`) VALUES ('$domainId', NOW(), '{$page}', compress('{$headers}'))";
			$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		}
	} else {
		echo "No headers \n";
	}
}

function storeCache( $domainId, $page ) {

	if( $page != '' ) {
		$page = addslashes( $page );

		$sql = "SELECT `domainId` FROM `cacheIndex` WHERE `domainId` = '$domainId'";
		$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		if( $res && ( mysql_num_rows( $res ) >0 )) {

			mysql_free_result( $res ) or error_sql( $sql, mysql_error() );

			$sql = "UPDATE `cacheIndex` SET `date` = NOW(), `index` = compress('{$page}') WHERE `domainId` = '$domainId'";
			$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		} else {

			$sql = "INSERT INTO `cacheIndex` (`domainId`, `date`,`index`) VALUES ('$domainId', NOW(), compress('{$page}'))";
			$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		}
	}
}

function storeRobot( $domainId, $page ) {

	if( $page != '' ) {
		$page = addslashes( $page );

		$sql = "SELECT `domainId` FROM `cacheRobot` WHERE `domainId` = '$domainId'";
		$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		if( $res && ( mysql_num_rows( $res ) >0 )) {

			mysql_free_result( $res ) or error_sql( $sql, mysql_error() );

			$sql = "UPDATE `cacheRobot` SET `date` = NOW(), `robot` = compress('{$page}') WHERE `domainId` = '$domainId'";
			$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		} else {

			$sql = "INSERT INTO `cacheRobot` (`domainId`, `date`,`robot`) VALUES ('$domainId', NOW(), compress('{$page}'))";
			$res = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		}
	}
}

function delay_domain( $domainId ) {

	if( $domainId = (int)$domainId ) {

		$sql = "UPDATE `domain` SET `lastindex`=NOW() WHERE id = {$domainId} LIMIT 1";
		$result = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		return true;

	} else {
		return false;
	}
}

function block_domain( $domainId, $reason = 'none', $info = '' ) {

	if( $domainId = (int)$domainId ) {

		$reason = addslashes($reason);
		$info = addslashes($info);

		$table = 'logBlock';
		$check = array('domainId'=>$domainId);
		$values = array();
		$values['date'] = date('Y-m-d H:i:s');
		$values['reason'] = $reason;
		$values['info'] = $info;

		insertOrUpdate ( $table, $values, $check );

		$sql = "UPDATE `domain` SET `status`='blocked', `lastindex`=NOW() WHERE id = {$domainId} LIMIT 1";
		$result = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		return true;

	} else {
		return false;
	}

}
function update_domain_store( $domainId ) {

	$squirt = "UPDATE `domain` SET `status` = 'stored', `lastindex`=NOW() WHERE id ='{$domainId}'";
	$result = ofdan_query($squirt);

}

function update_domain_pause( $domainId ) {

	$squirt = "UPDATE `domain` SET `status` = 'paused', `lastindex`=NOW() WHERE id ='{$domainId}'";
	$result = ofdan_query($squirt);

}

function getDomainId( $domain ) {

	$sql = "SELECT `id` FROM `domain` WHERE `domain`.`domain` = '{$domain}'";
	$result = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

	if( $result && mysql_num_rows($result) ) {
		list($domainId) = mysql_fetch_row($result);
		return $domainId;
	} else {
		return false;
	}
}

function add_domain_link( $domainId, $fromDomain ) {

	if( $domainId && $fromDomain ) {

		# get domain Id for both

#		$domainId = getDomainId($domain);
		$fromDomainId = getDomainId($fromDomain);

		if( $domainId && $fromDomainId ) {

			$sql = "INSERT INTO cacheLinks(`domainId`,`linkDomainId`) VALUES ($domainId, $fromDomainId)";
			$result = mysql_query( $sql ); # or error_sql( $sql, mysql_error() );

		} else {
			return false;
		}

	} else {
		return false;
	}

}

function add_queue_item( $domain ) {

	if($domain = getFilteredDomain( $domain )) {

		if( getDomainId( $domain ) === false )
		{
			$nextindex = processMetaRevist( array() );
			$squirt = "INSERT INTO `domain` ( `domain`, `status`,`nextindex`,`lastindex` ) VALUES ('" . $domain . "', 'queue', {$nextindex}, NOW() );";
			$result = ofdan_query($squirt);
		}
	}
}

function remove_queue_item( $domainId ) {

	if( $domainId = (int)$domainId ) {

		$sql = "UPDATE `domain` SET `status`='paused' WHERE `id`={$domainId} LIMIT 1";
		$result = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

		if( $result ) {

			return true;

		}

	}

	return false;

}

function addKeyword( $domainId, $word, $rank = 2500 ) {

	$sql = "SELECT `id` FROM `keyword2` WHERE `keyword`='{$word}' LIMIT 1;";
	$result = mysql_query( $sql ) or error_sql( $sql, mysql_error() );

	if( $result ) {

		$line = mysql_fetch_array($result);
		mysql_free_result( $result );

		$id = $line['id'];

	}

	if( !$id ) {
